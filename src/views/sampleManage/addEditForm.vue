<template>
  <Dialog v-model="dialogVisible" :width="dialogWidth" :title="dialogTitle" @close="handleClose">
    <template #title>
      <div class="dialog-header">
        <span><img v-if="dialogTitle === '新增'" src="@/assets/imgs/myUpdate/path2svg.svg"/>
              <img v-else-if="dialogTitle === '编辑' || dialogTitle === '编辑新增'" src="@/assets/imgs/myUpdate/editPath.svg"/>
               <img v-else src="@/assets/imgs/myUpdate/detailPath.svg"/>
          {{dialogTitle}}</span>
      </div>
    </template>
    <div class="h-80vh overflow-y-auto">
      <div ref="formContainer" class="w-100%">
        <el-form
          ref="formRef"
          v-loading="formLoading"
          :model="formData"
          :rules="formRules"
          label-width="120px"
          :style="{ paddingRight: '25px' }"
        >
          <el-row>
            <el-col :span="24">
              <el-col :span="24">
                <el-row>
                  <el-col :span="24">
                    <span class="title ml-10">基本信息</span>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="委托编号" prop="delegateNo">
                      <el-input v-model="formData.delegateNo" placeholder="请输入" maxlength="40" />
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="委托单日期" prop="delegateDate">
                      <el-date-picker
                        v-model="formData.delegateDate"
                        type="date"
                        placeholder="请选择"
                        value-format="YYYY.MM.DD"
                        class="!w-100%"
                      />
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="委托单位" prop="delegateUnitId">
                      <el-tree-select
                        filterable
                        v-model="formData.delegateUnitId"
                        :data="deptList"
                        :default-expanded-keys="[0]"
                        :props="defaultProps"
                        check-strictly
                        style="width: 100%"
                        node-key="id"
                      />
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="受检单位" prop="examineUnitId">
                      <el-tree-select
                        filterable
                        v-model="formData.examineUnitId"
                        :data="deptList"
                        :default-expanded-keys="[0]"
                        :props="defaultProps"
                        check-strictly
                        style="width: 100%"
                        node-key="id"
                      />
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="工程名称" prop="projectId">
                      <el-tree-select
                        filterable
                        v-model="formData.projectId"
                        :data="projectList"
                        :default-expanded-keys="[0]"
                        :props="defaultProjectProps"
                        check-strictly
                        style="width: 100%"
                        node-key="id"
                        @change="(id) => handleProjectNameChange(id, true)"
                      />
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="工程部位" prop="projectPartId">
                      <div class="flex items-center">
                        <el-tree-select
                          filterable
                          v-model="formData.projectPartId"
                          :data="projectPartList"
                          :default-expanded-keys="[0]"
                          :props="defaultProps2"
                          check-strictly
                          style="width: 130px"
                          node-key="id"
                          @node-click="handleProjectPartChange"
                        />
                        <span class="mx-2">-</span>
                        <el-input
                          v-model="formData.address"
                          placeholder="请输入详细地址"
                          maxlength="40"
                          style="flex: 1"
                        />
                      </div>
                    </el-form-item>
                  </el-col>
                </el-row>
              </el-col>
              <el-col :span="24">
                <el-row>
                  <el-col :span="24">
                    <span class="title ml-10">取样信息</span>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="取样地点" prop="takeAddress">
                      <el-input
                        v-model="formData.takeAddress"
                        placeholder="请输入"
                        maxlength="40"
                      />
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="样品名称" prop="sampleName">
                      <el-input
                        v-model="formData.sampleName"
                        placeholder="请输入"
                        maxlength="180"
                      />
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="样品编号" prop="sampleCode">
                      <!-- <el-input v-model="formData.sampleCode" placeholder="请输入" maxlength="40" /> -->
                      <el-select
                        v-model="formData.sampleCode"
                        placeholder="请选择"
                        clearable
                        allow-create
                        filterable
                      >
                        <el-option
                          v-for="dict in sampleCodeOptionsOptions"
                          :key="dict.code"
                          :label="dict.name"
                          :value="dict.name"
                        />
                      </el-select>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="样品状态" prop="sampleStatus">
                      <el-select
                        v-model="formData.sampleStatus"
                        placeholder="请选择"
                        multiple
                        clearable
                        filterable
                      >
                        <el-option
                          v-for="dict in sampleStatusOptions"
                          :key="dict.label"
                          :label="dict.label"
                          :value="dict.label"
                        />
                      </el-select>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="抽样数量" prop="samplingQuantity">
                      <el-input
                        v-model="formData.samplingQuantity"
                        placeholder="请输入"
                        maxlength="40"
                      />
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="收样人" prop="receivePerson">
                      <el-input
                        v-model="formData.receivePerson"
                        placeholder="请输入"
                        maxlength="30"
                      />
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="收样日期" prop="receiveDate">
                      <el-date-picker
                        v-model="formData.receiveDate"
                        type="date"
                        placeholder="请选择"
                        value-format="YYYY.MM.DD"
                        class="!w-100%"
                      />
                    </el-form-item>
                  </el-col>
                </el-row>
              </el-col>
              <el-col :span="24">
                <el-row>
                  <el-col :span="24">
                    <span class="title ml-10">检测信息</span>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="报告编号" prop="reportNumber">
                      <el-input
                        v-model="formData.reportNumber"
                        placeholder="请输入"
                        maxlength="40"
                      />
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="报告日期" prop="reportDate">
                      <el-date-picker
                        v-model="formData.reportDate"
                        type="date"
                        placeholder="请选择"
                        value-format="YYYY.MM.DD"
                        class="!w-100%"
                      />
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="检测设备" prop="testEquipment">
                      <el-select
                        v-model="formData.testEquipment"
                        placeholder="请选择"
                        filterable
                        :filter-method="filterinstrumentsAndEquipment"
                        multiple
                        clearable
                        
                      >
                        <el-option
                          v-for="dict in instrumentsAndEquipment"
                          :key="dict.value"
                          :label="dict.label"
                          :value="dict.value"
                        />
                      </el-select>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="检测环境" prop="reportDate">
                      <el-input
                        v-model="formData.testEnvironment"
                        placeholder="请输入"
                        maxlength="40"
                      />
                      <!-- <el-date-picker
                        v-model="formData.testEquipment"
                        type="date"
                        placeholder="请选择"
                        value-format="YYYY.MM.DD"
                        class="!w-100%"
                      /> -->
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="检测日期" prop="testDate">
                      <el-date-picker
                        v-model="formData.testDate"
                        type="date"
                        placeholder="请选择"
                        value-format="YYYY.MM.DD"
                        class="!w-100%"
                      />
                    </el-form-item>
                  </el-col>
                  <el-col :span="formData.propertyList?.length == 0 ? 12 : 24">
                    <el-form-item label="检测类别" prop="taskType">
                      <el-select
                        v-model="formData.taskType"
                        v-if="formData.propertyList?.length == 0"
                        placeholder="请选择"
                        clearable
                        filterable
                      >
                        <el-option
                          v-for="dict in taskTypeList"
                          :key="dict.value"
                          :label="dict.name"
                          :value="dict.value"
                        />
                      </el-select>
                      <el-popover
                        v-else
                        :width="900"
                        placement="bottom-start"
                        :offset="40"
                        :visible="true"
                        :teleported="false"
                        popper-class="popper_class"
                      >
                        <template #reference>
                          <el-select
                            v-model="formData.taskType"
                            placeholder="请选择"
                            clearable
                            width="400"
                            style="width: 40%"
                            filterable
                          >
                            <el-option
                              v-for="dict in taskTypeList"
                              :key="dict.value"
                              :label="dict.name"
                              :value="dict.value"
                            />
                          </el-select>
                        </template>
                        <!-- :style="{ height: dynamicHeight }" -->
                        <div class="pr-20px py-10px overflow-auto">
                          <div class="text-14px font-bold">{{ formData.examineName }}</div>
                          <template v-for="(item, index) in formData.propertyList">
                            <el-form-item
                              :key="item.propertyId"
                              class="mt-20px"
                              :label="item.propertyName"
                              :prop="'propertyList.' + index + '.propertyValue'"
                              :rules="{
                                required: true,
                                message: item.propertyName + '不能为空',
                                trigger: ['blur', 'change']
                              }"
                              v-if="!item.isMust"
                            >
                              <el-date-picker
                                v-model="formData.propertyList[index].propertyValue"
                                v-if="item.fieldType === 'DATE'"
                                type="date"
                                placeholder="请选择"
                                value-format="YYYY.MM.DD"
                                class="!w-100%"
                              />
                              <el-date-picker
                                v-model="formData.propertyList[index].propertyValue"
                                v-else-if="item.fieldType === 'DATETIME'"
                                type="datetime"
                                placeholder="请选择"
                                value-format="YYYY.MM.DD HH:mm:ss"
                                class="!w-100%"
                              />
                              <el-input
                                v-else
                                maxlength="255"
                                v-model="formData.propertyList[index].propertyValue"
                              />
                            </el-form-item>
                          </template>
                        </div>
                      </el-popover>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="品种" prop="sampleCategory">
                      <el-input
                        v-model="formData.sampleCategory"
                        placeholder="请输入"
                        maxlength="40"
                      />
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="材料类型" prop="materialId">
                      <el-tree-select
                        filterable
                        ref="materialTreeRef"
                        v-model="formData.materialId"
                        :data="materialList"
                        :default-expanded-keys="[0]"
                        :props="defaultProps1"
                        check-strictly
                        style="width: 100%"
                        node-key="id"
                        @change="(id) => handleChange(id)"
                      />
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="检测项目" prop="examineProjectId">
                      <el-select
                        filterable
                        v-model="formData.examineProjectId"
                        placeholder="请选择"
                      >
                        <el-option
                          v-for="dict in itemList"
                          :key="dict.id"
                          :label="dict.examineName"
                          :value="dict.id"
                          @click="handleProjectChange(dict)"
                        />
                      </el-select>
                      <!-- <el-popover
                        v-else
                        placement="bottom"
                        :width="450"
                        :offset="40"
                        :visible="true"
                        :teleported="false"
                        popper-class="popper_class"
                      >
                        <template #reference>
                          <el-select
                            filterable
                            v-model="formData.examineProjectId"
                            placeholder="请选择"
                            clearable
                          >
                            <el-option
                              v-for="dict in itemList"
                              :key="dict.id"
                              :label="dict.examineName"
                              :value="dict.id"
                              @click="handleProjectChange(dict)"
                            />
                          </el-select>
                        </template>
                        <div
                          class="pr-20px py-10px overflow-auto"
                        >
                          <div class="text-14px font-bold">{{ formData.examineName }}</div>
                          <template v-for="(item, index) in formData.propertyList">
                            <el-form-item
                              :key="item.propertyId"
                              class="mt-20px"
                              :label="item.propertyName"
                              :prop="'propertyList.' + index + '.propertyValue'"
                              :rules="{
                                required: true,
                                message: item.propertyName + '不能为空',
                                trigger: ['blur', 'change']
                              }"
                              v-if="!item.isMust"
                            >
                              <el-date-picker
                                v-model="formData.propertyList[index].propertyValue"
                                v-if="item.fieldType === 'DATE'"
                                type="date"
                                placeholder="请选择"
                                value-format="YYYY.MM.DD"
                                class="!w-100%"
                              />
                              <el-date-picker
                                v-model="formData.propertyList[index].propertyValue"
                                v-else-if="item.fieldType === 'DATETIME'"
                                type="datetime"
                                placeholder="请选择"
                                value-format="YYYY.MM.DD HH:mm:ss"
                                class="!w-100%"
                              />
                              <el-input
                                v-else
                                maxlength="255"
                                v-model="formData.propertyList[index].propertyValue"
                              />
                            </el-form-item>
                          </template>
                        </div>
                      </el-popover> -->
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="厂家" prop="factory">
                      <el-input v-model="formData.factory" placeholder="请输入" maxlength="40" />
                    </el-form-item>
                  </el-col>
                  <el-col
                    :span="12"
                    v-if="commissionOrderFields.includes(ORDER_FORM_KEY_MAP.factoryNumber.key)"
                  >
                    <el-form-item label="出厂编号" prop="factoryNumber">
                      <el-input
                        v-model="formData.factoryNumber"
                        placeholder="请输入"
                        maxlength="40"
                      />
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="规格型号" prop="modelNo">
                      <el-input v-model="formData.modelNo" placeholder="请输入" maxlength="40" />
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="代表数量" prop="representQuantity">
                      <el-input
                        v-model="formData.representQuantity"
                        placeholder="请输入"
                        maxlength="40"
                      />
                    </el-form-item>
                  </el-col>
                  <el-col
                    v-if="commissionOrderFields.includes(ORDER_FORM_KEY_MAP.examineContext.key)"
                    :span="12"
                  >
                    <el-form-item label="检测内容" prop="examineContext">
                      <el-input
                        v-model="formData.examineContext"
                        placeholder="请输入"
                        maxlength="200"
                      />
                    </el-form-item>
                  </el-col>
                  <el-col
                    v-if="commissionOrderFields.includes(ORDER_FORM_KEY_MAP.designParam.key)"
                    :span="12"
                  >
                    <el-form-item label="设计参数" prop="designParam">
                      <el-input
                        v-model="formData.designParam"
                        placeholder="请输入"
                        maxlength="200"
                      />
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="流程模型" prop="bpmModelId">
                      <el-select
                        v-model="formData.bpmModelId"
                        placeholder="请选择"
                        filterable
                        @change="handleChangeBpmModel"
                      >
                        <el-option
                          v-for="ite in modelList"
                          :key="ite.id"
                          :label="ite.name"
                          :value="ite.id"
                        />
                      </el-select>
                      <el-tooltip effect="dark" content="点击查看流程模型" placement="top">
                        <Icon
                          icon="ep:info-filled"
                          class="moreInfoIcon"
                          title="点击查看流程模型"
                          @click="handleBpmnDetail(formData.bpmModelId)"
                        />
                      </el-tooltip>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="试验标准" prop="examineBasis">
                      <el-select
                        v-model="formData.examineBasis"
                        placeholder="请选择"
                        multiple
                        :filter-method="filterMethod"
                        clearable
                        filterable
                      >
                        <el-option
                          v-for="dict in examineBasisOptions"
                          :key="dict.value"
                          :label="dict.label"
                          :value="dict.value"
                        />
                      </el-select>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="评定标准" prop="judgeStandard">
                      <el-select
                        v-model="formData.judgeStandard"
                        placeholder="请选择"
                        :filter-method="filterjudgeStandard"
                        multiple
                        clearable
                        filterable
                      >
                        <el-option
                          v-for="dict in judgeStandardOptions"
                          :key="dict.value"
                          :label="dict.label"
                          :value="dict.value"
                        />
                      </el-select>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <!-- <el-form-item label="收样人" prop="receivePerson">
                <el-input v-model="formData.receivePerson" placeholder="请输入" maxlength="30" />
              </el-form-item> -->
                    <el-form-item label="抽检人" prop="receivePerson">
                      <el-input
                        v-model="formData.receivePerson"
                        placeholder="请输入"
                        maxlength="30"
                      />
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="见证人" prop="witness">
                      <el-input v-model="formData.witness" placeholder="请输入" maxlength="30" />
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="已检样品处理" prop="handleResult">
                      <el-select
                        v-model="formData.handleResult"
                        placeholder="请选择"
                        clearable
                        filterable
                      >
                        <el-option
                          v-for="dict in handleResultOptions"
                          :key="dict.label"
                          :label="dict.label"
                          :value="dict.label"
                        />
                      </el-select>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="报告发送方式" prop="reportSendType">
                      <el-select
                        v-model="formData.reportSendType"
                        placeholder="请选择"
                        clearable
                        filterable
                      >
                        <el-option
                          v-for="dict in reportSendTypeOptions"
                          :key="dict.label"
                          :label="dict.label"
                          :value="dict.label"
                        />
                      </el-select>
                    </el-form-item>
                  </el-col>
                  <el-col
                    :span="12"
                    v-if="formType == 'create' || formType == 'edit' || formType == 'editAndCreate'"
                  >
                    <el-form-item label="检测人" prop="examiner">
                      <el-select
                        v-model="formData.examiner"
                        placeholder="请选择"
                        clearable
                        filterable
                        @change="handleChangeExaminer"
                      >
                        <el-option
                          v-for="dict in userList"
                          :key="dict.id"
                          :label="dict.nickname"
                          :value="dict.id"
                        />
                      </el-select>
                    </el-form-item>
                  </el-col>
                  <el-col v-if="showNext" :span="12">
                    <el-form-item label="下一节点处理人" prop="userId">
                      <el-select
                        v-model="formData.userId"
                        placeholder="请选择"
                        clearable
                        filterable
                        @change="handleNextUserChange"
                      >
                        <el-option
                          v-for="dict in userList"
                          :key="dict.id"
                          :label="dict.nickname"
                          :value="dict.id"
                        />
                      </el-select>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="检测单位" prop="examineDeptId">
                      <el-tree-select
                        filterable
                        v-model="formData.examineDeptId"
                        :data="deptList"
                        :default-expanded-keys="[0]"
                        :props="defaultProps"
                        check-strictly
                        style="width: 100%"
                        node-key="id"
                      />
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="检测人联系方式" prop="examinerPhone">
                      <el-input
                        v-model="formData.examinerPhone"
                        placeholder="请输入"
                        maxlength="200"
                      />
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item
                      label="上传附件"
                      v-if="formType !== 'initiate'"
                      prop="attachment1"
                    >
                      <UploadFileChunk
                        class="min-w-80px"
                        v-model="formData.attachment1"
                        :accept="[
                          'doc',
                          'docx',
                          'xls',
                          'xlsx',
                          'ppt',
                          'pptx',
                          'txt',
                          'pdf',
                          'jpg',
                          'jpeg',
                          'png',
                          'gif',
                          'zip',
                          'rar'
                        ]"
                        :limit="5"
                        :progressWidth="100"
                        :filenameWidth="100"
                        @before-upload="handleBeforeUpload"
                        @success="handleUploadSuccess"
                        @error="handleUploadError"
                      />
                    </el-form-item>
                  </el-col>
                </el-row>
              </el-col>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </div>
    <template #footer>
      <el-button :disabled="formLoading" color="#3F6297" @click="submitForm">
        <Icon icon="ep:document-add" class="mr-1"/>
        确 定</el-button>
      <el-button @click="dialogVisible = false">
        <Icon icon="ep:close" class="mr-1"/>
        取 消</el-button>
    </template>
  </Dialog>
  <!-- 弹窗：流程模型图的预览 -->
  <Dialog title="流程图" v-model="bpmnDetailVisible" width="800">
    <MyProcessViewer
      class="customPv"
      key="designer"
      v-model="bpmnXML"
      :value="bpmnXML"
      v-bind="bpmnControlForm"
      :prefix="bpmnControlForm.prefix"
    />
  </Dialog>
</template>
<script setup>
import { is, isNil, isEmpty, either } from 'ramda'
import UploadFileChunk from '@/components/UploadFile/UploadFileChunk/UploadModal.vue'
import { nextTick, ref, computed } from 'vue'
import { MyProcessViewer } from '@/components/bpmnProcessDesigner/package'
import { DICT_TYPE, getStrDictOptions } from '@/utils/dict'
import * as DeptApi from '@/api/system/dept'
import { defaultProps, handleTree } from '@/utils/tree'
import { DEPARTMENT_BUSINESS_MAP } from '@/constants/business'
import * as ledgerManage from '@/api/ledgerManage'
import * as SampleApi from '@/api/sample'
import * as ItemApi from '@/api/itemManage'
import * as ModelApi from '@/api/bpm/model'
import * as TaskApi from '@/api/task'

import * as InspectionItemApi from '@/api/inspectionItem'

const ORDER_FORM_KEY_MAP = {
  factoryNumber: {
    key: 'factoryNumber',
    name: '出厂编号'
  },
  examineContext: {
    key: 'examineContext',
    name: '检测内容'
  },
  designParam: {
    key: 'designParam',
    name: '设计参数'
  },
  examineDeptId: {
    key: 'examineDeptId',
    name: "'检测单位id"
  }
}

const isNilOrEmpty = either(isNil, isEmpty)

const { t } = useI18n() // 国际化
const message = useMessage() // 消息弹窗

// 添加试验标准选项
const examineBasisOptions = ref([])
const judgeStandardOptions = ref([])
const instrumentsAndEquipment = ref([])
const sampleStatusOptions = ref([])
const sampleCodeOptionsOptions = ref([])
const handleResultOptions = ref([])
const reportSendTypeOptions = ref([])

const taskTypeList = ref([
  {
    name: '委托',
    value: '1'
  },
  {
    name: '自检',
    value: '2'
  }
])

const materialList = ref([])
const dialogVisible = ref(false) // 弹窗的是否展示
const dialogTitle = ref('') // 弹窗的标题
const formLoading = ref(false) // 表单的加载中：1）修改时的数据加载；
// 2）提交的按钮禁用
const submitBtnLoading = ref(false)
const formType = ref('') // 表单的类型：create - 新增；update - 修改
const deptList = ref([])
const projectList = ref([])
const fileList = ref([])
const fileRef = ref(null)
const originalProperty = ref([])

const userList = ref([])
const itemList = ref([])
const formData = ref({
  sampleCode: '',
  sampleName: '',
  projectId: '', // 工程名称
  examineProjectId: undefined, // 检测指标
  examineContext: '', // 检测内容
  designParam: '', // 设计参数
  materialId: '', // 物料种类ID
  delegateUnitId: '', // 委托单位ID
  examineUnitId: '', // 受检单位ID
  inputDate: '', // 收样日期
  attachment1: '', // 附件
  attachment: '', // 附件
  taskType: '', // 检测类别
  sendExaminer: undefined, // 收样人
  examiner: undefined, // 检测人
  equipmentId: '', // 设备ID
  bpmModelId: undefined,
  propertyList: [],
  delegateNo: '', // 委托编号
  takeAddress: '', // 取样地点
  address: '', // 详细地址
  projectPartId: '', // 工程部位
  samplingQuantity: '', // 抽样数量
  sampleCategory: '', // 品种
  factory: '', // 厂家
  factoryNumber: '', // 出厂编号
  sampleStatus: [], // 样品状态
  modelNo: '', // 规格型号
  representQuantity: '', // 代表数量
  examineBasis: [], // 试验标准
  judgeStandard: [], // 评定标准
  receivePerson: '', // 抽检人
  receiveDate: '', // 收样日期
  handleResult: '', // 已检样品处理
  reportSendType: '', // 报告发送方式
  userId: '', // 下一节点处理人
  examineDeptId: '', // 检测单位Id
  examinerPhone: '', // 检测人电话
  witness: '', // 见证人
  delegateDate: '' // 委托日期
})
const mobile = ref('')

const defaultProps1 = {
  children: 'children',
  label: 'materialName'
}

const defaultProjectProps = {
  children: 'children',
  label: 'projectName',
  disabled: (data, node) => {
    const { children } = data
    const isNoChildren = !children || children.length === 0

    // console.log('🚀 ~ data:', data, node)
    return isNoChildren
  }
}
const defaultProps2 = {
  children: 'children',
  label: 'projectName'
}
const formRules = reactive({
  taskType: [{ required: true, message: '检测类别不能为空', trigger: 'change' }],
  sampleCode: [{ required: true, message: '样品编号不能为空', trigger: 'change' }],
  sampleName: [{ required: true, message: '样品名称不能为空', trigger: 'change' }],
  projectId: [{ required: true, message: '工程名称不能为空', trigger: 'change' }],
  materialId: [{ required: true, message: '材料类型不能为空', trigger: 'change' }],
  delegateUnitId: [{ required: true, message: '委托单位不能为空', trigger: 'change' }],
  delegateNo: [{ required: true, message: '委托编号不能为空', trigger: 'change' }],
  // address: [{ required: true, message: '详细地址不能为空', trigger: 'change' }],
  sendExaminer: [{ required: true, message: '送检人不能为空', trigger: 'change' }],
  examineProjectId: [{ required: true, message: '检测项目不能为空', trigger: 'change' }],
  examineContext: [{ required: true, message: '检测内容不能为空', trigger: 'change' }],
  designParam: [{ required: true, message: '设计参数不能为空', trigger: 'change' }],
  bpmModelId: [{ required: true, message: '流程模型不能为空', trigger: 'change' }],
  examiner: [{ required: true, message: '检测人不能为空', trigger: 'change' }],
  samplingQuantity: [{ required: true, message: '抽样数量不能为空', trigger: 'change' }],
  examineUnitId: [{ required: true, message: '受检单位不能为空', trigger: 'change' }],
  takeAddress: [{ required: true, message: '取样地点不能为空', trigger: 'change' }],
  projectPartId: [{ required: true, message: '工程部位不能为空', trigger: 'change' }],
  sampleCategory: [{ required: true, message: '品种不能为空', trigger: 'change' }],
  factory: [{ required: true, message: '厂家不能为空', trigger: 'change' }],
  // NOTE: 2025.4新增
  factoryNumber: [{ required: true, message: '出厂编号不能为空', trigger: 'change' }],
  modelNo: [{ required: true, message: '规格型号不能为空', trigger: 'change' }],
  representQuantity: [{ required: true, message: '代表数量不能为空', trigger: 'change' }],
  sampleStatus: [{ required: true, message: '样品状态不能为空', trigger: 'change' }],
  examineBasis: [{ required: true, message: '试验标准不能为空', trigger: 'change' }],
  judgeStandard: [{ required: true, message: '评定标准不能为空', trigger: 'change' }],
  handleResult: [{ required: true, message: '已检样品处理不能为空', trigger: 'change' }],
  reportSendType: [{ required: true, message: '报告发送方式不能为空', trigger: 'change' }],
  receivePerson: [{ required: true, message: '抽检人不能为空', trigger: 'change' }],
  witness: [{ required: false, message: '见证人不能为空', trigger: 'change' }],
  receiveDate: [{ required: true, message: '收样日期不能为空', trigger: 'change' }],
  delegateDate: [{ required: true, message: '委托日期不能为空', trigger: 'change' }],
  userId: [{ required: true, message: '下一节点处理人不能为空', trigger: 'change' }],
  examineDeptId: [{ required: true, message: '检测单位不能为空', trigger: 'change' }],
  examinerPhone: [{ required: true, message: '检测人联系方式不能为空', trigger: 'change' }]
})
const formRef = ref() // 表单 Ref
const materialTreeRef = ref() // 材料类型树Ref
const materialName = ref('') // 材料类型名称
const commissionOrderFields = ref([]) // 材料类型名称

const modelList = ref([])

const dialogWidth = computed(() => {
  // return formData.value.propertyList?.length > 0 ? '1400px' : '1000px'
  return '1000px'
})
const formContainer = ref(null)
const dynamicHeight = ref('500px')
const calculateHeight = async () => {
  await nextTick(() => {
    if (formContainer.value) {
      let height = formContainer.value.offsetHeight
      height >= 650 && (height = 650)
      dynamicHeight.value = `${height - 10}px` // 额外添加一些边距
      console.log('高度：', dynamicHeight.value, height)
    }
  })
}
// 在打开弹窗或属性列表变化时调用
watch(() => formData.value.propertyList, calculateHeight)

const getTree = async () => {
  const res = await DeptApi.getSimpleDeptList()
  deptList.value = []
  deptList.value.push(...handleTree(res))
}

async function handleChange(value) {
  formData.value.bpmModelId = undefined
  let nodeData = materialTreeRef.value.getNode(value)
  const step = nodeData.level - 1

  for (let i = 0; i < step; i++) {
    if (!nodeData.parent) {
      break
    }

    nodeData = nodeData.parent
  }

  const _materialName = nodeData.data?.materialName

  if (materialName.value !== _materialName) {
    const dicts = await getStrDictOptions(_materialName)

    formData.value.factoryNumber = ''
    formData.value.examineContext = ''
    formData.value.designParam = ''
    materialName.value = _materialName
    commissionOrderFields.value = dicts.map((dict) => dict.value)
    // console.log('🚀 ~ dicts:', dicts, commissionOrderFields.value)
  }

  fetchItemList(value)
}

//
const filterinstrumentsAndEquipment = async (query) => {
  instrumentsAndEquipment.value = []
  if (query === '') {
    instrumentsAndEquipment.value = await getStrDictOptions('device')
  } else {
    instrumentsAndEquipment.value = await instrumentsAndEquipmentList.value.filter((item) =>
      item.label.toLowerCase().includes(query.toLowerCase())
    )
  }
}

const filterMethod = async (query) => {
  examineBasisOptions.value = []

  if (query === '') {
    examineBasisOptions.value = await getStrDictOptions('standardNorms')
  } else {
    examineBasisOptions.value = await examineBasisOptionsList.value.filter((item) =>
      item.label.toLowerCase().includes(query.toLowerCase())
    )
  }
}
const filterjudgeStandard = async (query) => {
  judgeStandardOptions.value = []
  if (query === '') {
    judgeStandardOptions.value = await getStrDictOptions('standardNorms')
  } else {
    judgeStandardOptions.value = await examineBasisOptionsList.value.filter((item) =>
      item.label.toLowerCase().includes(query.toLowerCase())
    )
  }
}

const recurBuildProjectTree = () => {}

const getProjectTree = async () => {
  const data = await ItemApi.getItemList({ projectType: 0 })
  console.log('🚀 ~ getProjectTree ~ data:', data)
  projectList.value = data.map((d) => {
    // d.disabled = true
    return d
  })
}

let materialId = null
// 改变材料种类
const fetchItemList = async (data) => {
  const res = await InspectionItemApi.getExamineProjectList({
    materialType: data,
    publishStatus: 1
  })
  itemList.value = res
  if (!materialId) {
    formData.value.examineProjectId = undefined
    formData.value.propertyList = []
  }
  materialId = null
  // handleProjectChange(res[0])
}

/** 查询流程模型列表 */
const getModelList = async () => {
  try {
    const { list } = await ModelApi.getModelPage({
      pageNo: 1,
      pageSize: 100,
      bizTagList: [DEPARTMENT_BUSINESS_MAP.jc.key],
      publishStatus: 1
    })

    const data = []

    list.forEach((ite) => {
      if (ite.processDefinition?.version) {
        data.push({
          id: ite.id,
          processDefinitionId: ite.processDefinition.id,
          name: ite.name,
          key: ite.key
        })
      }
    })

    modelList.value = data
  } finally {
    //
  }
}
const handleChangeBpmModel = async (id) => {
  if (formType.value === 'initiate') {
    await Promise.all(
      modelList.value.map(async (ite) => {
        console.log('手动触发', (ite.id, id))
        if (ite.id === id) {
          const res = await TaskApi.getProcessDefinition({ id: ite.processDefinitionId })
          checkMine(res, ite.key)
        }
      })
    )
  }
}

let examineProjectId = ''
let uploadKey = undefined
const showNext = ref(false)
const examineBasisOptionsList = ref([])
const instrumentsAndEquipmentList = ref([])
// 初始提交下一节点处理人
// 初始提交下一节点处理人
const checkMine = function (res, key) {
  if (!res.nodeUserSelectTasks) {
    console.error('nodeUserSelectTasks is undefined')
    return
  }

  const firstTask = res.nodeUserSelectTasks.find((item) => item.id !== key)
  if (!firstTask) {
    console.error('No task found with id different from', key)
    return
  }

  uploadKey = firstTask.id
  if (firstTask.isSelectUser) {
    formData.value.userId = formData.value.examiner
    showNext.value = true
  } else {
    showNext.value = false
  }
}

// const handleUploadSuccess = (data) => {
//   fileList.value.push(data)
// }
const handleBeforeUpload = () => {
  submitBtnLoading.value = true
}

const handleUploadSuccess = (fileInfo) => {
  console.log('上传成功:', fileInfo, formData.value.attachment1)
  const hasUploadingFiles = (fileInfo ?? [])?.filter((file) => !file || !file.url)

  if (!hasUploadingFiles.length) {
    submitBtnLoading.value = false
  }

  // 手动触发表单验证
  // formRef.value?.validateField('attachment')
}
const handleUploadError = () => {
  submitBtnLoading.value = false
}

const getUserList = async () => {
  const res = await SampleApi.getUserListNoPage()
  userList.value = res
}

// const handleRemove = (index) => {
//   fileList.value.splice(index, 1)
// }
/** 打开弹窗 */

const buildMultiString2Arr = (obj, key) => {
  if (isNil(obj[key]) || isEmpty(obj[key])) {
    obj[key] = []
  } else if (is(String, obj[key]) && obj[key]) {
    obj[key] = obj[key].split('、')
  }
}

const open = async (type, id) => {
  getMaterialTree()
  getTree()
  getProjectTree()
  getUserList()
  // 获取试验标准字典数据
  // NOTE: 试验标准和评定标准，按最新要求用同一个字典
  examineBasisOptions.value = await getStrDictOptions('standardNorms')
  examineBasisOptionsList.value = examineBasisOptions.value

  judgeStandardOptions.value = await getStrDictOptions('standardNorms')
  instrumentsAndEquipment.value = await getStrDictOptions('device')
  instrumentsAndEquipmentList.value = instrumentsAndEquipment.value
  sampleStatusOptions.value = await getStrDictOptions('sample_status')
  sampleCodeOptionsOptions.value = await ledgerManage.gettestdata()
  handleResultOptions.value = await getStrDictOptions('handle_result')
  reportSendTypeOptions.value = await getStrDictOptions('report_send_type')
  resetForm()
  showNext.value = false
  dialogVisible.value = true

  if (type === 'initiate') {
    dialogTitle.value = '任务发起'
  } else if (type === 'editAndCreate') {
    dialogTitle.value = '编辑新增'
  } else {
    dialogTitle.value = t('action.' + type)
  }
  getModelList()
  formType.value = type

  if (id) {
    formLoading.value = true
    submitBtnLoading.value = true

    // try {
    // const resData = await SampleApi.getSampleInfoDetail(id)
    // TODO: 目前先这么处理
    // formData.value.examiner = formData.value.examiner ? Number(formData.value.examiner) : undefined
    // if (formType.value === 'initiate') {
    //   const { delegateUnitId, examineUnitId, projectId, materialId, sampleCode, sampleName } =
    //     resData
    //   formData.value.delegateUnitId = delegateUnitId
    //   formData.value.examineUnitId = examineUnitId
    //   formData.value.projectId = projectId
    //   formData.value.materialId = materialId
    //   formData.value.sampleCode = sampleCode
    //   formData.value.sampleName = sampleName
    // } else {
    //   formData.value = resData
    // }

    try {
      const resData = await SampleApi.getSampleInfoDetail(id)
      handleProjectNameChange(resData.projectId)
      if (resData.testEquipment) {
        resData.testEquipment = resData.testEquipment.split('、')
      } else {
        resData.testEquipment = []
      }
      formData.value = resData
      buildMultiString2Arr(formData.value, 'sampleStatus')
      buildMultiString2Arr(formData.value, 'examineBasis')
      buildMultiString2Arr(formData.value, 'judgeStandard')

      // ==================================== new =======================================
      let nodeData = materialTreeRef.value.getNode(formData.value.materialId)
      const step = nodeData.level - 1

      for (let i = 0; i < step; i++) {
        if (!nodeData.parent) {
          break
        }

        nodeData = nodeData.parent
      }

      const _materialName = nodeData.data?.materialName

      const dicts = await getStrDictOptions(_materialName)

      // const user = userList.value?.find((user) => user.id == resData.examiner) ?? {}
      // const { mobile: _mobile } = user
      // console.log('🚀 ~ dicts.mobile:', _mobile)
      // formData.value.examineDeptId = deptId
      // TODO: 打算放到formData里，可编辑
      // mobile.value = _mobile
      materialName.value = _materialName
      commissionOrderFields.value = dicts.map((dict) => dict.value)
      console.log('🚀 ~ dicts111:', dicts, commissionOrderFields.value)
      // ==================================== new =======================================
      // if (isNil(formData.value.sampleStatus) || isEmpty(formData.value.sampleStatus)) {
      //   formData.value.sampleStatus = []
      // } else if (is(String, formData.value.sampleStatus) && formData.value.sampleStatus) {
      //   formData.value.sampleStatus = formData.value.sampleStatus.split('、')
      // }

      formData.value.examiner = formData.value.examiner
        ? Number(formData.value.examiner)
        : undefined
      formData.value.examineName = resData.examineProjectName
      examineProjectId = resData.examineProjectId
      materialId = resData.materialId
      // 将 property 对象转换为数组
      const propertyArray = resData.property ? Object.values(resData.property) : []
      // Filter out items with specified propertyNames or isMust=1
      // const filteredPropertyArray = propertyArray.filter(
      //   (item) =>
      //     ![
      //       'examineProjectName',
      //       'delegateUnitName',
      //       'examineUnitName',
      //       'projectName',
      //       'sampleName',
      //       'sampleCode'
      //     ].includes(item.propertyKey) && item.isMust !== 1
      // )
      const filteredPropertyArray = propertyArray.filter((item) => item.isMust !== 1)
      originalProperty.value = filteredPropertyArray
      formData.value.propertyList = filteredPropertyArray

      if (formType.value === 'initiate') {
        await getModelList()
        handleChangeBpmModel(formData.value.bpmModelId)
      }

      const attachmentList = JSON.parse(formData.value.attachment || '[]')
      // fileList.value = attachmentList
      formData.value.attachment1 = attachmentList
      fetchItemList(formData.value.materialId)
    } catch (error) {
      console.error('open error:', error)
    } finally {
      formLoading.value = false
      submitBtnLoading.value = false
    }
  }
}

const getMaterialTree = async () => {
  materialList.value = await InspectionItemApi.getMaterialTree({ businessType: 1 })
}
const handleProjectChange = async (val) => {
  console.log('检测指标改变:', val)
  formData.value.bpmModelId = undefined
  formData.value.examineName = val.examineName
  // 如果当前选择的检测指标ID与之前的相同，则保持 propertyList 不变
  if (formData.value.examineProjectId !== examineProjectId) {
    formLoading.value = true
    const data = await InspectionItemApi.getExamineProjectDetail(val.id)
    formLoading.value = false
    console.log('data', data.propertyList)

    // Filter out items with specified propertyNames or isMust=1
    formData.value.propertyList = data.propertyList?.length
      ? data.propertyList
          .filter((item) => item.isMust !== 1)
          .map((item) => {
            !item.propertyValue && (item.propertyValue = '')
            return item
          })
      : []
    console.log('formData.value.propertyList', formData.value.propertyList)
  } else {
    formData.value.propertyList = originalProperty.value
    originalProperty.value = []
    examineProjectId = null
  }
  // 改变检测指标的联动操作
  // itemList 指标集合
  const hitProject = itemList.value?.find((ite) => ite.id === val.id)

  if (hitProject) {
    const { bpmModelId } = hitProject
    formData.value.bpmModelId = bpmModelId
    bpmModelId && handleChangeBpmModel(bpmModelId)
  }
}

/** 重置表单 */
const resetForm = () => {
  formData.value = {
    sampleCode: '',
    sampleName: '',
    projectId: '', // 工程名称
    examineProjectId: undefined, // 检测指标
    examineContext: '', // 检测内容
    designParam: '', // 设计参数
    materialId: '', // 物料种类ID
    delegateUnitId: '', // 委托单位ID
    examineUnitId: '', // 受检单位ID
    inputDate: '', // 收样日期
    attachment1: '', // 附件
    attachment: '', // 附件
    taskType: '', // 检测类别
    sendExaminer: undefined, // 收样人
    examiner: undefined, // 试验人
    equipmentId: '', // 设备ID
    bpmModelId: undefined,
    propertyList: [],
    delegateNo: '', // 委托编号
    takeAddress: '', // 取样地点
    address: '', // 详细地址
    projectPartId: '', // 工程部位
    samplingQuantity: '', // 抽样数量
    sampleCategory: '', // 品种
    factory: '', // 厂家
    factoryNumber: '', // 出厂编号
    sampleStatus: [], // 样品状态
    modelNo: '', // 规格型号
    representQuantity: '', // 代表数量
    examineBasis: [], // 试验标准
    judgeStandard: [], // 评定标准
    receivePerson: '', // 抽检人
    receiveDate: '', // 收样日期
    handleResult: '', // 已检样品处理
    reportSendType: '', // 报告发送方式
    userId: '', // 下一节点处理人
    examineDeptId: '', // 检测单位ID
    examinerPhone: '', // 试验人手机号
    witness: '', //见证人
    delegateDate: '' // 委托单日期
  }

  mobile.value = ''
  formRef.value?.resetFields()
}
defineExpose({ open }) // 提供 open 方法，用于打开弹窗

/** 提交表单 */
const emit = defineEmits(['success']) // 定义 success 事件，用于操作成功后的回调
const submitForm = async () => {
  // 校验表单
  if (!formRef.value) return
  const valid = await formRef.value.validate()
  if (!valid) return
  // 提交请求
  formLoading.value = true
  // debugger
  // formData.value.attachment = JSON.stringify(formData.value.attachment1 || [])
  // formData.value.attachment1 = undefined
  if (formData.value.testEquipment) {
    formData.value.testEquipment = formData.value.testEquipment.join('、')
  }
  const payloadData = { ...formData.value }
  payloadData.attachment = JSON.stringify(payloadData.attachment1 || [])
  payloadData.attachment1 = undefined
  payloadData.sampleStatus = formData.value.sampleStatus?.join('、')
  payloadData.examineBasis = formData.value.examineBasis?.join('、')
  payloadData.judgeStandard = formData.value.judgeStandard?.join('、')
  console.log('🚀 ~ submitForm ~ payloadData:', payloadData)
  console.log('🚀 ~ submitForm ~ formData:', formData.value)

  try {
    if (formType.value === 'create') {
      await SampleApi.createSampleInfo(payloadData)
      message.success(t('common.createSuccess'))
    } else if (formType.value === 'editAndCreate') {
      payloadData.id = null
      await SampleApi.createSampleInfo(payloadData)
    } else if (formType.value === 'edit') {
      await SampleApi.updateSampleInfo(payloadData)
      message.success(t('common.updateSuccess'))
    } else if (formType.value === 'initiate') {
      await SampleApi.updateSampleInfo(payloadData)
      const {
        taskType,
        id: businessKey,
        examineProjectId,
        bpmModelId,
        examiner,
        userId
      } = formData.value ?? {}
      const payload = {
        taskType,
        businessKey,
        examineProjectId,
        bpmModelId,
        examiner,
        variables: {
          [uploadKey]: [userId]
        }
      }
      console.log('payload', payload)
      await TaskApi.createTask(payload)
      // message.success(t('common.updateSuccess'))
      message.success('任务发起成功')
    } else {
      //
    }
    dialogVisible.value = false
    // 发送操作成功的事件
    emit('success')
  } finally {
    formLoading.value = false
  }
}

/** 流程图的详情按钮操作 */
const bpmnDetailVisible = ref(false)
const bpmnXML = ref(null)
const bpmnControlForm = ref({
  prefix: 'flowable'
})

const handleBpmnDetail = async (id) => {
  if (!id) {
    return message.warning('请先选择流程模型')
  }

  const data = await ModelApi.getModel(id)
  bpmnXML.value = data.bpmnXml || ''
  bpmnDetailVisible.value = true
}

const projectPartList = ref([])

// 项目选择改变时的处理函数
const handleProjectNameChange = async (id, clear = false) => {
  if (!id) return

  if (clear) {
    formData.value.projectPartId = ''
    formData.value.projectPart = ''
    projectPartList.value = []
  }

  const res = await ItemApi.getItemList({ projectType: 0, projectId: id })
  projectPartList.value = res ?? []
}

const handleProjectPartChange = (nodeData) => {
  formData.value.projectPart = nodeData.projectName
}

const handleChangeExaminer = (id) => {
  const user = userList.value?.find((user) => user.id == id) ?? {}
  // console.log('🚀 ~ handleChangeExaminer ~ rest:', id, user)
  const { mobile: _mobile, deptId } = user
  formData.value.examineDeptId = deptId
  formData.value.examinerPhone = _mobile
}

const handleNextUserChange = (id) => {
  formData.value.examiner = id
  const user = userList.value?.find((user) => user.id == id) ?? {}
  const { mobile: _mobile, deptId } = user
  formData.value.examineDeptId = deptId
  formData.value.examinerPhone = _mobile
}

const handleClose = () => {
  formLoading.value = false
  submitBtnLoading.value = false
}
</script>
<style lang="scss" scoped>
@import '@/styles/tableCommon.scss';
.moreInfoIcon {
  position: absolute;
  right: -20px;
  cursor: pointer;
}
</style>
<style lang="scss">
.customPv {
  height: 560px !important;
}

.popper_class {
  top: 10px !important;
  left: 0 !important;
  // position: absolute  !important;
  // height: 560px !important;
  position: relative !important;
  display: block !important;
  background-color: #f2f6fc !important;
  box-shadow: none !important;

  // .el-popper__arrow {
  //   top: 60px !important;
  //   left: -4px !important;
  // }

  // .el-popper__arrow::before {
  //   width: 14px;
  //   height: 14px;
  //   background-color: #f2f6fc !important;
  // }
}
</style>
