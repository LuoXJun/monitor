<template>
  <Dialog v-model="dialogVisible" width="1000px" :title="dialogTitle">
    <div class="container">
      <el-form ref="formRef" inline v-loading="formLoading" :model="formData" :rules="formRules">
        <el-form-item label="Ë°®ÂêçÁß∞" prop="tableName">
          <el-input
            v-model="formData.tableName"
            placeholder="ËØ∑ËæìÂÖ•"
            clearable
            @keydown.enter="handleQuery"
            class="!w-240px"
          />
        </el-form-item>
        <el-form-item>
          <el-button color="#2559ec" dark @click="handleQuery">
            <Icon icon="ep:search" />ÊêúÁ¥¢
          </el-button>
          <el-button @click="resetQuery"> <Icon icon="ep:refresh" />ÈáçÁΩÆ </el-button>
          <el-button color="#2559ec" plain @click="handleEdit(OPERATE_TYPE_MAP.create.key)">
            <Icon icon="ep:plus" />Êñ∞Â¢û
          </el-button>
        </el-form-item>
      </el-form>
      <div class="wrap">
        <div class="table-wrap">
          <vxe-table
            ref="tableRef"
            border
            stripe
            show-overflow="tooltip"
            height="528"
            :loading="loading"
            :data="list"
            :checkbox-config="checkboxConfig"
            :rowConfig="{ keyField: 'id' }"
            @checkbox-all="handleSelectionAllChange"
            @checkbox-change="handleSelectionChange"
          >
            <vxe-column type="checkbox" title="" width="50" align="center" />
            <vxe-column type="seq" title="Â∫èÂè∑" width="80" align="center" show-overflow-tooltip />
            <vxe-column field="tableName" title="Ë°®ÂêçÁß∞" align="center" show-overflow-tooltip />
            <vxe-column field="tableDesc" title="Ë°®Ê≥®Èáä" align="center" show-overflow-tooltip />
            <vxe-column title="Êìç‰Ωú" width="140">
              <template #default="{ row }">
                <span class="operate-group">
                  <el-button
                    type="primary"
                    size="small"
                    plain
                    v-hasPermi="['sql:db:edit']"
                    @click="handleEdit(OPERATE_TYPE_MAP.edit.key, row.tableName)"
                  >
                    ÁºñËæë
                  </el-button>
                  <el-button
                    size="small"
                    plain
                    type="danger"
                    v-hasPermi="['sql:db:delete']"
                    @click="handleDelete(row)"
                    :disabled="row.tableType === 1"
                  >
                    Âà†Èô§
                  </el-button>
                </span>
              </template>
            </vxe-column>
          </vxe-table>
          <Pagination
            :total="total"
            v-model:page="formData.pageNo"
            v-model:limit="formData.pageSize"
            @pagination="getList"
          />
        </div>
        <div class="selected-wrap">
          <div class="selected-header">
            <span>Â∑≤ÈÄâÔºà{{ multipleSelection.length }}Ôºâ</span>
          </div>
          <div class="selected-content">
            <div class="selected-item" v-for="item in multipleSelection" :key="item.id">
              <div class="selected-item-content">
                <div class="selected-item-content-block">
                  <div class="selected-item-label">Ë°®ÂêçÁß∞Ôºö</div>
                  <div class="selected-item-content-value" :title="item.tableName">
                    {{ item.tableName }}
                  </div>
                </div>
                <div class="selected-item-content-block">
                  <div class="selected-item-label">Ë°®Ê≥®ÈáäÔºö</div>
                  <div class="selected-item-content-value" :title="item.tableDesc">
                    {{ item.tableDesc }}
                  </div>
                </div>
              </div>
              <Icon class="close-icon" icon="ep:close" @click="handleRemoveSelected(item)" />
            </div>
          </div>
        </div>
      </div>
    </div>
    <template #footer>
      <el-button :disabled="formLoading" type="primary" @click="submitForm">Á°Æ ÂÆö</el-button>
      <el-button @click="dialogVisible = false">Âèñ Ê∂à</el-button>
    </template>
  </Dialog>
  <AddEditDataBaseModal ref="addEditDataBaseModalRef" @success="handleEditTableSuccess" />
</template>
<script setup>
import * as R from 'ramda'
import * as SqlApi from '@/api/sql'
import { addExamineTable } from '@/api/inspectionItem'
import { TZ_BASE_TABLE_NAME } from '@/components/luckysheet/constants/index'
import { getSheetsHasConfigFields } from '@/components/luckysheet/utils/util'
import AddEditDataBaseModal from '@/views/databaseManage/addEditForm.vue'
import { OPERATE_TYPE_MAP } from '@/constants/databaseManage'

defineOptions({ name: 'AddTableForm' })

const props = defineProps({
  examineId: {
    type: String,
    default() {
      return ''
    }
  },
  selectedTable: {
    type: Array,
    default() {
      return []
    }
  }
})

const checkboxConfig = reactive({
  reserve: true,
  checkRowKeys: [],
  checkMethod: ({ row }) => {
    return row.tableName !== TZ_BASE_TABLE_NAME
  }
})

const { t } = useI18n() // ÂõΩÈôÖÂåñ
const message = useMessage() // Ê∂àÊÅØÂºπÁ™ó
const dialogVisible = ref(false) // ÂºπÁ™óÁöÑÊòØÂê¶Â±ïÁ§∫
const dialogTitle = ref('Êñ∞Â¢û‰∏öÂä°Ë°®') // ÂºπÁ™óÁöÑÊ†áÈ¢ò
const formLoading = ref(false) // Ë°®ÂçïÁöÑÂä†ËΩΩ‰∏≠Ôºö1Ôºâ‰øÆÊîπÊó∂ÁöÑÊï∞ÊçÆÂä†ËΩΩÔºõ2ÔºâÊèê‰∫§ÁöÑÊåâÈíÆÁ¶ÅÁî®
const loading = ref(false) // Ë°®ÂçïÁöÑÂä†ËΩΩ‰∏≠Ôºö1Ôºâ‰øÆÊîπÊó∂ÁöÑÊï∞ÊçÆÂä†ËΩΩÔºõ2ÔºâÊèê‰∫§ÁöÑÊåâÈíÆÁ¶ÅÁî®
const formType = ref('') // Ë°®ÂçïÁöÑÁ±ªÂûãÔºöcreate - Êñ∞Â¢ûÔºõupdate - ‰øÆÊîπ
const formData = ref({
  tableName: undefined,
  pageNo: 1,
  pageSize: 20
})
const formRules = reactive({})
const formRef = ref() // Ë°®Âçï Ref
const list = ref([]) // ÂàóË°®
const total = ref(0) // ÂàóË°®ÊÄªÊï∞
const tableRef = ref()
const multipleSelection = ref([])
const existTableList = ref([])

/** Êèê‰∫§Ë°®Âçï */
const emit = defineEmits(['success', 'delete:table']) // ÂÆö‰πâ success ‰∫ã‰ª∂ÔºåÁî®‰∫éÊìç‰ΩúÊàêÂäüÂêéÁöÑÂõûË∞É

/** Êü•ËØ¢ÂàóË°® */
const getList = async () => {
  loading.value = true
  try {
    const data = await SqlApi.getDbPage(formData.value)
    list.value = data.list
    total.value = data.total

    // ‰∏∫‰∫ÜÂà∑Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ
    tableRef.value.reloadData(list.value)
  } finally {
    loading.value = false
  }
}

/** ÊêúÁ¥¢ÊåâÈíÆÊìç‰Ωú */
const handleQuery = async () => {
  formData.value.pageNo = 1
  await getList()
}

/** ÈáçÁΩÆÊåâÈíÆÊìç‰Ωú */
const resetQuery = async () => {
  // TODO: ËøôÈáå‰ºöÈáçÁΩÆÈÄâ‰∏≠ÁöÑË°åÔºåÂÖ∑‰ΩìË¶Å‰∏çË¶ÅÈáçÁΩÆÔºåÁúã‰∏öÂä°ÈúÄÊ±Ç
  // resetCheckRowKeysOnResetQuery()
  formRef.value?.resetFields()
  await handleQuery()
}

const addEditDataBaseModalRef = ref(null)

const openEditTableForm = (operateType, tableName) => {
  let sheetsFields = []

  if (operateType === OPERATE_TYPE_MAP.edit.key) {
    sheetsFields = getSheetsHasConfigFields()
  }
  addEditDataBaseModalRef.value.open(operateType, tableName, sheetsFields)
}

const handleEdit = (operateType, tableName) => {
  openEditTableForm(operateType, tableName)
}

const handleDelete = async (row) => {
  console.log('üöÄ ~ handleDelete ~ row:', row)
  const tableName = row.tableName

  try {
    // Âà†Èô§ÁöÑ‰∫åÊ¨°Á°ÆËÆ§
    await message.delConfirm()
    // ÂèëËµ∑Âà†Èô§
    await SqlApi.deleteDb(tableName)
    message.success(t('common.delSuccess'))
    // Âà∑Êñ∞ÂàóË°®
    await getList()

    existTableList.value = existTableList.value.filter((item) => item.id !== row.id)
    multipleSelection.value = multipleSelection.value.filter((item) => item.id !== row.id)
    checkboxConfig.checkRowKeys = checkboxConfig.checkRowKeys.filter((id) => id !== row.id)

    emit('delete:table', row)
  } catch {}
}

const handleEditTableSuccess = () => {
  getList()
  emit('success')
}

const handleSelectionAllChange = (val) => {
  console.log('üöÄ ~ handleSelectionAllChange ~ val:', val)
  const { checked, records } = { ...val }
  if (checked) {
    records?.forEach?.((record) => {
      const { id } = record
      const isNew = !multipleSelection.value?.find?.((selected) => selected.id === id)
      if (isNew) {
        multipleSelection.value?.push?.(R.clone(record))
        checkboxConfig.checkRowKeys.push(id)
      }
    })
  } else {
    multipleSelection.value?.forEach?.((selected) => {
      const existRow = list.value?.find?.((data) => data.id === selected.id)
      if (existRow) {
        multipleSelection.value = multipleSelection.value?.filter?.(
          (selected) => selected.id !== existRow.id
        )
        checkboxConfig.checkRowKeys = checkboxConfig.checkRowKeys?.filter?.(
          (key) => key !== existRow.id
        )
      }
    })
  }
}

const handleSelectionChange = (val) => {
  const { checked, row } = { ...val }
  const { id } = row

  if (checked) {
    multipleSelection.value?.push?.(row)
    checkboxConfig.checkRowKeys.push(id)
  } else {
    multipleSelection.value = multipleSelection.value?.filter?.((selected) => selected.id !== id)
    checkboxConfig.checkRowKeys = checkboxConfig.checkRowKeys?.filter?.((_id) => _id !== id)
  }
}

const handleRemoveSelected = (selectedRow) => {
  // console.log('üöÄ ~ handleRemoveSelected ~ selectedRow:', selectedRow)
  // 1. Âà†Èô§ multipleSelection ‰∏≠ÁöÑÊï∞ÊçÆ
  multipleSelection.value = multipleSelection.value.filter((item) => item.id !== selectedRow.id)

  // ÁõÆÂâçÊòØÂΩìÂâçÈ°µÁöÑ
  const selectedRows = tableRef.value.getCheckboxRecords(false)
  const removeRow = selectedRows.find?.((row) => row.id === selectedRow.id)

  // 2. Âà†Èô§ tableRef ‰∏≠ÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
  // 2‰∏™ÈÉΩË°åÔºå‰ªªÈÄâ‰∏Ä‰∏™
  // removeRow && tableRef.value.setCheckboxRow(removeRow, false)
  removeRow && tableRef.value.setCheckboxRowKey(removeRow.id, false)

  // 3. Âà†Èô§checkboxConfig.checkRowKeys
  checkboxConfig.checkRowKeys = checkboxConfig.checkRowKeys.filter((id) => id !== selectedRow.id)
}

/** ÊâìÂºÄÂºπÁ™ó */
const open = async (selectedTable = []) => {
  console.log('üöÄ ~ open ~ selectedTable:', selectedTable)
  dialogVisible.value = true

  resetForm()

  const selectedList = selectedTable?.map?.((table) => ({
    id: table.id,
    tableName: table.value,
    tableDesc: table.label
  }))

  existTableList.value = R.clone(selectedList)
  multipleSelection.value = selectedList
  checkboxConfig.checkRowKeys = selectedList.map((item) => item.id)

  await getList()

  formLoading.value = false
}

const resetCheckRowKeysOnResetQuery = () => {
  multipleSelection.value = R.clone(existTableList.value)
  checkboxConfig.checkRowKeys = existTableList.value?.map?.((item) => item.id)
}

/** ÈáçÁΩÆË°®Âçï */
const resetForm = () => {
  formData.value = {
    tableName: undefined,
    pageNo: 1,
    pageSize: 10
  }

  existTableList.value = []
  multipleSelection.value = []
  checkboxConfig.checkRowKeys = []

  formRef.value?.resetFields()
}

defineExpose({ open }) // Êèê‰æõ open ÊñπÊ≥ïÔºåÁî®‰∫éÊâìÂºÄÂºπÁ™ó

const submitForm = async () => {
  // Ê†°È™åË°®Âçï
  if (!formRef) return

  const valid = await formRef.value.validate()

  if (!valid) return
  // Êèê‰∫§ËØ∑Ê±Ç
  formLoading.value = true
  console.log('üöÄ ~ submitForm ~ multipleSelection.value:', multipleSelection.value)

  // TODO: ÊöÇÊó∂Ê≥®ÈáäÔºåËÆ∞ÂæóÊâìÂºÄ
  try {
    const tableIds = multipleSelection.value.map((item) => item.id)
    await addExamineTable({ tableIds, examineId: props.examineId })

    dialogVisible.value = false
    // ÂèëÈÄÅÊìç‰ΩúÊàêÂäüÁöÑ‰∫ã‰ª∂
    emit('success')
  } finally {
    formLoading.value = false
  }
}
</script>
<style lang="scss" scoped>
.container {
  height: 618px;
}

.wrap {
  display: flex;
  flex-direction: row;

  .table-wrap {
    // width: 600px;
    width: 70%;
  }

  .selected-wrap {
    padding: 10px;
    flex: 1;

    .selected-header {
      padding: 3px 0;
    }

    .selected-content {
      height: 488px;
      padding: 10px 0;
      overflow-y: auto;
      flex: 1;
    }
  }
}

.selected-item {
  display: flex;
  padding: 6px;
  margin-bottom: 10px;
  // cursor: pointer;
  border: 1px solid #ccc;
  border-radius: 5px;
  align-items: center;
  justify-content: space-between;

  &:hover {
    background-color: #f5f5f5;
  }
}

.selected-item:hover {
  background-color: #f5f5f5;
}

.selected-item-content {
  width: 90%;
}

.selected-item-content-block {
  display: flex;
  align-items: flex-start;
  justify-content: flex-start;
}

.selected-item-label {
  width: 58px;
}

.selected-item-content-value {
  max-width: 110px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  flex: 1;
}

.close-icon {
  flex: 1;
  cursor: pointer;

  &:hover {
    transform: scale(1.2);
  }
}

.operate-group {
  display: flex;
  justify-content: center;
}
</style>
